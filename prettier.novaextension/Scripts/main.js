"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e={};class t extends Error{constructor(e,t){super(t),this.status=e}}function r(e){const t=function(e){const t=nova.workspace.config.get(e);switch(t){case"Enabled":return!0;case"Disabled":return!1;case"Global Setting":return null;default:return t}}(e),r=nova.config.get(e);return null===t?r:t}var i={showError:function(e,t,r){let i=new NotificationRequest(e);i.title=nova.localize(t),i.body=nova.localize(r),i.actions=[nova.localize("OK")],nova.notifications.add(i).catch((e=>console.error(e,e.stack)))},showActionableError:function(e,t,r,i,n){let s=new NotificationRequest(e);s.title=nova.localize(t),s.body=nova.localize(r),s.actions=i.map((e=>nova.localize(e))),nova.notifications.add(s).then((e=>n(e.actionIdx))).catch((e=>console.error(e,e.stack)))},log:Object.fromEntries(["log","info","warn"].map((e=>[e,(...t)=>{(nova.inDevMode()||r("prettier.debug.logging"))&&console[e](...t)}]))),getConfigWithWorkspaceOverride:r,observeConfigWithWorkspaceOverride:function(e,t){let r=!1;function i(...e){r?t.apply(this,e):r=!0}nova.workspace.config.observe(e,i),nova.config.observe(e,i)},ProcessError:t,handleProcessResult:function(e,r,i){const n=[];e.onStderr((e=>{n.push(e)})),e.onDidExit((e=>{0!==e?r(new t(e,n.join("\n"))):i&&i()}))}};const{handleProcessResult:n,log:s}=i;function o(e,t,r){for(;;){const i=nova.path.join(e,t),n=nova.fs.stat(i);if(n){if(r(i,n))return{directory:e,path:i}}if("/"===e)break;e=nova.path.dirname(e)}return null}async function a(e,t){let r,i;const o=new Promise(((e,t)=>{r=e,i=t})),a=new Process("/usr/bin/env",{args:["npm","ls",t,"--parseable","--long","--depth","0"],cwd:e});return a.onStdout((e=>{if(!e||!e.trim())return;const[i,n,o,a]=e.trim().split(":");return n&&n.startsWith(`${t}@`)?i===nova.workspace.path?(s.info(`You seem to be working on ${t}! The extension doesn't work without ${t} built, so using the built-in ${t} instead.`),r(null)):void r({path:i,correctVersion:"INVALID"!==o&&"MAXDEPTH"!==a}):r(null)})),n(a,i,r),a.start(),o}var l=-1;function h(e,t,r,i,n){if(e===t)return e?[[0,e]]:[];if(null!=r){var s=function(e,t,r){var i="number"==typeof r?{index:r,length:0}:r.oldRange,n="number"==typeof r?null:r.newRange,s=e.length,o=t.length;if(0===i.length&&(null===n||0===n.length)){var a=i.index,l=e.slice(0,a),h=e.slice(a),c=n?n.index:null,g=a+o-s;if((null===c||c===g)&&!(g<0||g>o)){var u=t.slice(0,g);if((f=t.slice(g))===h){var p=Math.min(a,g);if((v=l.slice(0,p))===(y=u.slice(0,p)))return C(v,l.slice(p),u.slice(p),h)}}if(null===c||c===a){var d=a,f=(u=t.slice(0,d),t.slice(d));if(u===l){var m=Math.min(s-d,o-d);if((b=h.slice(h.length-m))===(w=f.slice(f.length-m)))return C(l,h.slice(0,h.length-m),f.slice(0,f.length-m),b)}}}if(i.length>0&&n&&0===n.length){var v=e.slice(0,i.index),b=e.slice(i.index+i.length);if(!(o<(p=v.length)+(m=b.length))){var y=t.slice(0,p),w=t.slice(o-m);if(v===y&&b===w)return C(v,e.slice(p,s-m),t.slice(p,o-m),b)}}return null}(e,t,r);if(s)return s}var o=g(e,t),a=e.substring(0,o);o=p(e=e.substring(o),t=t.substring(o));var w=e.substring(e.length-o),S=function(e,t){var r;if(!e)return[[1,t]];if(!t)return[[l,e]];var i=e.length>t.length?e:t,n=e.length>t.length?t:e,s=i.indexOf(n);if(-1!==s)return r=[[1,i.substring(0,s)],[0,n],[1,i.substring(s+n.length)]],e.length>t.length&&(r[0][0]=r[2][0]=l),r;if(1===n.length)return[[l,e],[1,t]];var o=function(e,t){var r=e.length>t.length?e:t,i=e.length>t.length?t:e;if(r.length<4||2*i.length<r.length)return null;function n(e,t,r){for(var i,n,s,o,a=e.substring(r,r+Math.floor(e.length/4)),l=-1,h="";-1!==(l=t.indexOf(a,l+1));){var c=g(e.substring(r),t.substring(l)),u=p(e.substring(0,r),t.substring(0,l));h.length<u+c&&(h=t.substring(l-u,l)+t.substring(l,l+c),i=e.substring(0,r-u),n=e.substring(r+c),s=t.substring(0,l-u),o=t.substring(l+c))}return 2*h.length>=e.length?[i,n,s,o,h]:null}var s,o,a,l,h,c=n(r,i,Math.ceil(r.length/4)),u=n(r,i,Math.ceil(r.length/2));if(!c&&!u)return null;s=u?c&&c[4].length>u[4].length?c:u:c;e.length>t.length?(o=s[0],a=s[1],l=s[2],h=s[3]):(l=s[0],h=s[1],o=s[2],a=s[3]);var d=s[4];return[o,a,l,h,d]}(e,t);if(o){var a=o[0],u=o[1],d=o[2],f=o[3],m=o[4],v=h(a,d),b=h(u,f);return v.concat([[0,m]],b)}return function(e,t){for(var r=e.length,i=t.length,n=Math.ceil((r+i)/2),s=n,o=2*n,a=new Array(o),h=new Array(o),g=0;g<o;g++)a[g]=-1,h[g]=-1;a[s+1]=0,h[s+1]=0;for(var u=r-i,p=u%2!=0,d=0,f=0,m=0,v=0,b=0;b<n;b++){for(var y=-b+d;y<=b-f;y+=2){for(var w=s+y,S=(k=y===-b||y!==b&&a[w-1]<a[w+1]?a[w+1]:a[w-1]+1)-y;k<r&&S<i&&e.charAt(k)===t.charAt(S);)k++,S++;if(a[w]=k,k>r)f+=2;else if(S>i)d+=2;else if(p){if((C=s+u-y)>=0&&C<o&&-1!==h[C])if(k>=(P=r-h[C]))return c(e,t,k,S)}}for(var x=-b+m;x<=b-v;x+=2){for(var P,C=s+x,E=(P=x===-b||x!==b&&h[C-1]<h[C+1]?h[C+1]:h[C-1]+1)-x;P<r&&E<i&&e.charAt(r-P-1)===t.charAt(i-E-1);)P++,E++;if(h[C]=P,P>r)v+=2;else if(E>i)m+=2;else if(!p){if((w=s+u-x)>=0&&w<o&&-1!==a[w]){var k;S=s+(k=a[w])-w;if(k>=(P=r-P))return c(e,t,k,S)}}}}return[[l,e],[1,t]]}(e,t)}(e=e.substring(0,e.length-o),t=t.substring(0,t.length-o));return a&&S.unshift([0,a]),w&&S.push([0,w]),y(S,n),i&&function(e){var t=!1,r=[],i=0,n=null,s=0,o=0,a=0,h=0,c=0;for(;s<e.length;)0==e[s][0]?(r[i++]=s,o=h,a=c,h=0,c=0,n=e[s][1]):(1==e[s][0]?h+=e[s][1].length:c+=e[s][1].length,n&&n.length<=Math.max(o,a)&&n.length<=Math.max(h,c)&&(e.splice(r[i-1],0,[l,n]),e[r[i-1]+1][0]=1,i--,s=--i>0?r[i-1]:-1,o=0,a=0,h=0,c=0,n=null,t=!0)),s++;t&&y(e);(function(e){function t(e,t){if(!e||!t)return 6;var r=e.charAt(e.length-1),i=t.charAt(0),n=r.match(d),s=i.match(d),o=n&&r.match(f),a=s&&i.match(f),l=o&&r.match(m),h=a&&i.match(m),c=l&&e.match(v),g=h&&t.match(b);return c||g?5:l||h?4:n&&!o&&a?3:o||a?2:n||s?1:0}var r=1;for(;r<e.length-1;){if(0==e[r-1][0]&&0==e[r+1][0]){var i=e[r-1][1],n=e[r][1],s=e[r+1][1],o=p(i,n);if(o){var a=n.substring(n.length-o);i=i.substring(0,i.length-o),n=a+n.substring(0,n.length-o),s=a+s}for(var l=i,h=n,c=s,g=t(i,n)+t(n,s);n.charAt(0)===s.charAt(0);){i+=n.charAt(0),n=n.substring(1)+s.charAt(0),s=s.substring(1);var u=t(i,n)+t(n,s);u>=g&&(g=u,l=i,h=n,c=s)}e[r-1][1]!=l&&(l?e[r-1][1]=l:(e.splice(r-1,1),r--),e[r][1]=h,c?e[r+1][1]=c:(e.splice(r+1,1),r--))}r++}})(e),s=1;for(;s<e.length;){if(e[s-1][0]==l&&1==e[s][0]){var g=e[s-1][1],w=e[s][1],S=u(g,w),x=u(w,g);S>=x?(S>=g.length/2||S>=w.length/2)&&(e.splice(s,0,[0,w.substring(0,S)]),e[s-1][1]=g.substring(0,g.length-S),e[s+1][1]=w.substring(S),s++):(x>=g.length/2||x>=w.length/2)&&(e.splice(s,0,[0,g.substring(0,x)]),e[s-1][0]=1,e[s-1][1]=w.substring(0,w.length-x),e[s+1][0]=l,e[s+1][1]=g.substring(x),s++),s++}s++}}(S),S}function c(e,t,r,i){var n=e.substring(0,r),s=t.substring(0,i),o=e.substring(r),a=t.substring(i),l=h(n,s),c=h(o,a);return l.concat(c)}function g(e,t){if(!e||!t||e.charAt(0)!==t.charAt(0))return 0;for(var r=0,i=Math.min(e.length,t.length),n=i,s=0;r<n;)e.substring(s,n)==t.substring(s,n)?s=r=n:i=n,n=Math.floor((i-r)/2+r);return w(e.charCodeAt(n-1))&&n--,n}function u(e,t){var r=e.length,i=t.length;if(0==r||0==i)return 0;r>i?e=e.substring(r-i):r<i&&(t=t.substring(0,r));var n=Math.min(r,i);if(e==t)return n;for(var s=0,o=1;;){var a=e.substring(n-o),l=t.indexOf(a);if(-1==l)return s;o+=l,0!=l&&e.substring(n-o)!=t.substring(0,o)||(s=o,o++)}}function p(e,t){if(!e||!t||e.slice(-1)!==t.slice(-1))return 0;for(var r=0,i=Math.min(e.length,t.length),n=i,s=0;r<n;)e.substring(e.length-n,e.length-s)==t.substring(t.length-n,t.length-s)?s=r=n:i=n,n=Math.floor((i-r)/2+r);return S(e.charCodeAt(e.length-n))&&n--,n}var d=/[^a-zA-Z0-9]/,f=/\s/,m=/[\r\n]/,v=/\n\r?\n$/,b=/^\r?\n\r?\n/;function y(e,t){e.push([0,""]);for(var r,i=0,n=0,s=0,o="",a="";i<e.length;)if(i<e.length-1&&!e[i][1])e.splice(i,1);else switch(e[i][0]){case 1:s++,a+=e[i][1],i++;break;case l:n++,o+=e[i][1],i++;break;case 0:var h=i-s-n-1;if(t){if(h>=0&&P(e[h][1])){var c=e[h][1].slice(-1);if(e[h][1]=e[h][1].slice(0,-1),o=c+o,a=c+a,!e[h][1]){e.splice(h,1),i--;var u=h-1;e[u]&&1===e[u][0]&&(s++,a=e[u][1]+a,u--),e[u]&&e[u][0]===l&&(n++,o=e[u][1]+o,u--),h=u}}if(x(e[i][1])){c=e[i][1].charAt(0);e[i][1]=e[i][1].slice(1),o+=c,a+=c}}if(i<e.length-1&&!e[i][1]){e.splice(i,1);break}if(o.length>0||a.length>0){o.length>0&&a.length>0&&(0!==(r=g(a,o))&&(h>=0?e[h][1]+=a.substring(0,r):(e.splice(0,0,[0,a.substring(0,r)]),i++),a=a.substring(r),o=o.substring(r)),0!==(r=p(a,o))&&(e[i][1]=a.substring(a.length-r)+e[i][1],a=a.substring(0,a.length-r),o=o.substring(0,o.length-r)));var d=s+n;0===o.length&&0===a.length?(e.splice(i-d,d),i-=d):0===o.length?(e.splice(i-d,d,[1,a]),i=i-d+1):0===a.length?(e.splice(i-d,d,[l,o]),i=i-d+1):(e.splice(i-d,d,[l,o],[1,a]),i=i-d+2)}0!==i&&0===e[i-1][0]?(e[i-1][1]+=e[i][1],e.splice(i,1)):i++,s=0,n=0,o="",a=""}""===e[e.length-1][1]&&e.pop();var f=!1;for(i=1;i<e.length-1;)0===e[i-1][0]&&0===e[i+1][0]&&(e[i][1].substring(e[i][1].length-e[i-1][1].length)===e[i-1][1]?(e[i][1]=e[i-1][1]+e[i][1].substring(0,e[i][1].length-e[i-1][1].length),e[i+1][1]=e[i-1][1]+e[i+1][1],e.splice(i-1,1),f=!0):e[i][1].substring(0,e[i+1][1].length)==e[i+1][1]&&(e[i-1][1]+=e[i+1][1],e[i][1]=e[i][1].substring(e[i+1][1].length)+e[i+1][1],e.splice(i+1,1),f=!0)),i++;f&&y(e,t)}function w(e){return e>=55296&&e<=56319}function S(e){return e>=56320&&e<=57343}function x(e){return S(e.charCodeAt(0))}function P(e){return w(e.charCodeAt(e.length-1))}function C(e,t,r,i){return P(e)||x(i)?null:function(e){for(var t=[],r=0;r<e.length;r++)e[r][1].length>0&&t.push(e[r]);return t}([[0,e],[l,t],[1,r],[0,i]])}function E(e,t,r,i){return h(e,t,r,i,!0)}E.INSERT=1,E.DELETE=l,E.EQUAL=0;const k=E,{showError:R,showActionableError:F,log:I,getConfigWithWorkspaceOverride:A}=i,j=String.fromCharCode(65533,65535,127124,127117,57348,127117).split(""),D=["arrowParens","bracketSameLine","bracketSpacing","embeddedLanguageFormatting","endOfLine","htmlWhitespaceSensitivity","insertPragma","jsxBracketSameLine","jsxSingleQuote","printWidth","proseWrap","quoteProps","requirePragma","semi","singleAttributePerLine","singleQuote","tabWidth","trailingComma","useTabs","vueIndentScriptAndStyle"],O=["phpVersion","singleQuote","trailingCommaPHP","braceStyle"],$=["xmlQuoteAttributes","xmlSelfClosingSpace","xmlSortAttributesByKey","xmlWhitespaceSensitivity"],_=["language","keywordCase","dataTypeCase","functionCase","identifierCase","logicalOperatorNewline","expressionWidth","linesBetweenQueries","denseOperators","newlineBeforeSemicolon","params","paramTypes"],W=["database","type"],L=["alignDirectives","alignUniversally","wrapParameters","continuationIndent"];var N={Formatter:class{constructor(){this.prettierServiceDidExit=this.prettierServiceDidExit.bind(this),this.prettierServiceStartDidFail=this.prettierServiceStartDidFail.bind(this),this.emitter=new Emitter,this.setupIsReadyPromise()}get defaultConfig(){return Object.fromEntries(D.map((e=>[e,A(`prettier.default-config.${e}`)])))}get phpConfig(){return Object.fromEntries(O.map((e=>[e,A(`prettier.plugins.prettier-plugin-php.${e}`)])))}get xmlConfig(){return Object.fromEntries($.map((e=>[e,A(`prettier.plugins.prettier-plugin-xml.${e}`)])))}get sqlFormatterConfig(){return Object.fromEntries(_.map((e=>[e,A(`prettier.plugins.prettier-plugin-sql.sql-formatter.${e}`)])))}get nginxConfig(){return Object.fromEntries(L.map((e=>[e,A(`prettier.plugins.prettier-plugin-sql.sql-formatter.${e}`)])))}get nodeSqlParserConfig(){return Object.fromEntries(W.map((e=>[e,A(`prettier.plugins.prettier-plugin-nginx.${e}`)])))}get isReady(){return this._isReadyPromise?this._isReadyPromise:(this.showServiceNotRunningError(),!1)}async start(e){e&&(this.modulePath=e),this._isReadyPromise||this.setupIsReadyPromise(),this._isStoppedPromise&&await _isStoppedPromise,this.prettierService||(I.info("Starting Prettier service"),this.prettierService=new Process("/usr/bin/env",{args:["node",nova.path.join(nova.extension.path,"Scripts","prettier-service","prettier-service.js"),this.modulePath],stdio:"jsonrpc",cwd:nova.workspace.path}),this.prettierService.onDidExit(this.prettierServiceDidExit),this.prettierService.onNotify("didStart",(()=>{this._resolveIsReadyPromise(!0)})),this.prettierService.onNotify("startDidFail",this.prettierServiceStartDidFail),this.prettierService.start())}stop(){if(nova.notifications.cancel("prettier-not-running"),this._isReadyPromise&&this.prettierService&&!this._isStoppedPromise)return I.info("Stopping Prettier service"),this._isStoppedPromise=new Promise((e=>{this._resolveIsStoppedPromise=e})),this._resolveIsReadyPromise&&this._resolveIsReadyPromise(!1),this._isReadyPromise=null,this.prettierService.terminate(),this.prettierService=null,this._isStoppedPromise}setupIsReadyPromise(){this._isReadyPromise=new Promise((e=>{this._resolveIsReadyPromise=e}))}prettierServiceDidExit(e){if(this._resolveIsStoppedPromise&&(this._resolveIsStoppedPromise(),this._isStoppedPromise=null),this.prettierService){if(console.error(`Prettier service exited with code ${e}`),this._resolveIsReadyPromise&&this._resolveIsReadyPromise(!1),this._isReadyPromise=null,this.prettierService=null,this.prettierServiceCrashedRecently)return this.showServiceNotRunningError();this.prettierServiceCrashedRecently=!0,setTimeout((()=>this.prettierServiceCrashedRecently=!1),5e3),this.start()}}prettierServiceStartDidFail({parameters:e}){this._resolveIsReadyPromise(!1),F("prettier-not-running","Couldn't Load Prettier","Please ensure your Node.js installation is up to date. Additionally, check if the 'Prettier module' path is correctly set in your extension or project settings. For more details, refer to the error log in the Extension Console",["Project settings","Extension settings"],(e=>{switch(e){case 0:nova.workspace.openConfig();break;case 1:nova.openConfig()}})),console.error(`${e.name}: ${e.message}\n${e.stack}`)}showServiceNotRunningError(){F("prettier-not-running","Prettier Stopped Running","If this problem persists, please report the issue through the Extension Library.",["Restart Prettier"],(e=>{if(0===e)this.start()}))}async formatEditor(e,t,r){const{document:i}=e;nova.notifications.cancel("prettier-unsupported-syntax");const n=i.path||nova.workspace.path,s=await this.shouldApplyDefaultConfig(i,t,n);if(null===s)return[];I.info(`Formatting ${i.path}`);const o=new Range(0,i.length),a=e.getTextInRange(o),l=A("prettier.plugins.prettier-plugin-php.enabled"),h=A("prettier.plugins.prettier-plugin-sql.enabled"),c=A("prettier.plugins.prettier-plugin-xml.enabled"),g=A("prettier.plugins.prettier-plugin-nginx.enabled"),u=A("prettier.plugins.prettier-plugin-sql.formatter");let p=[];this.modulePath.includes(nova.extension.path)&&("php"===i.syntax&&l&&p.push(nova.path.join(nova.extension.path,"node_modules","@prettier","plugin-php","src","index.mjs")),"sql"===i.syntax&&h&&p.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-sql","lib","index.cjs")),"xml"===i.syntax&&c&&p.push(nova.path.join(nova.extension.path,"node_modules","@prettier","plugin-xml","src","plugin.js")),"nginx"===i.syntax&&g&&p.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-nginx","dist","index.js")));const d={parser:this.getParserForSyntax(i.syntax),...p.length>0?{plugins:p}:{},...i.path?{filepath:i.path}:{},...s?this.defaultConfig:{},...r?{rangeStart:e.selectedRange.start,rangeEnd:e.selectedRange.end}:{}};"php"===i.syntax&&Object.assign(d,this.phpConfig),"xml"===i.syntax&&Object.assign(d,this.xmlConfig),"sql"===i.syntax&&("sql-formatter"===u?Object.assign(d,this.sqlFormatterConfig):"node-sql-parser"===u&&Object.assign(d,this.nodeSqlParserConfig)),"nginx"===i.syntax&&Object.assign(d,this.nginxConfig),I.info("Prettier options:",JSON.stringify(d,null,2));const f=await this.prettierService.request("format",{original:a,pathForConfig:n,ignorePath:t&&this.getIgnorePath(n),options:d}),{formatted:m,error:v,ignored:b,missingParser:y}=f;return v?this.issuesFromPrettierError(v):b?(I.info(`Prettier is configured to ignore ${i.path}`),[]):y?(t||R("prettier-unsupported-syntax","Syntax Not Supported","Prettier doesn't include a parser for this file, and no installed plugin provides one."),I.info(`No parser for ${i.path}`),[]):m===a?(I.info(`No changes for ${i.path}`),[]):void await this.applyResult(e,a,m)}async shouldApplyDefaultConfig(e,t,r){if(t&&!0===A(`prettier.format-on-save.ignored-syntaxes.${e.syntax}`))return I.info(`Not formatting (${e.syntax} syntax ignored) ${e.path}`),null;let i=!1;if(e.isRemote){if(t&&A("prettier.format-on-save.ignore-remote"))return null}else if(i=await this.prettierService.request("hasConfig",{pathForConfig:r}),!i&&t&&A("prettier.format-on-save.ignore-without-config"))return null;return!i}getIgnorePath(e){const t=nova.workspace.path||nova.path.dirname(e);return nova.path.join(t,".prettierignore")}getParserForSyntax(e){switch(e){case"javascript":case"jsx":return"babel";case"tsx":return"typescript";case"flow":return"babel-flow";case"html+erb":return"erb";default:return e}}async applyResult(e,t,r){I.info(`Applying formatted changes to ${e.document.path}`);const[i,n]=this.diff(t,r,e.selectedRanges);if(t===e.getTextInRange(new Range(0,e.document.length)))return n?this.applyDiff(e,i,n):this.replace(e,r);I.info(`Document ${e.document.path} was changed while formatting`)}diff(e,t,r){const i=j.find((r=>!e.includes(r)&&!t.includes(r)));if(!i)return null;let n="",s=0;for(const t of r)n+=e.slice(s,t.start)+i+e.slice(t.start,t.end)+i,s=t.end;return n+=e.slice(s),[i,k(n,t)]}async applyDiff(e,t,r){const i=[];await e.edit((e=>{let n=0,s=0;r.push([k.EQUAL,""]);for(const[o,a]of r)if(o!==k.DELETE)o===k.EQUAL&&s?e.replace(new Range(n,n+s),""):o===k.INSERT&&e.replace(new Range(n,n+s),a),s=0,n+=a.length;else{s+=a.length;let e=-1;for(;e=a.indexOf(t,e+1),-1!==e;){const e=i[i.length-1];!e||e[1]?i[i.length]=[n]:e[1]=n,s-=t.length}}})),e.selectedRanges=i.map((e=>new Range(e[0],e[1])))}async replace(e,t){const{document:r}=e,i=e.selectedRange.end,n=new Range(0,r.length);await e.edit((e=>{e.replace(n,t)})),e.selectedRanges=[new Range(i,i)]}issuesFromPrettierError(e){if("string"!=typeof e.message)return[];if("UndefinedParserError"===e.name)throw e;let t=e.message.match(/\((\d+):(\d+)\)\n/m);if(!t&&(t=e.message.match(/^>\s*?(\d+)\s\|\s/m),t)){const r=e.message.match(/^\s+\|(\s+)\^+($|\n)/im);t[2]=r?r[1].length+1:0}if(!t)throw e;const r=new Issue;return r.message=e.stack?e.message:e.message.split(/\n\s*?at\s+/i)[0],r.severity=IssueSeverity.Error,r.line=t[1],r.column=t[2],[r]}}};const q=async function(){if(nova.workspace.path){try{const e=function(e,t){const r=o(e,"package.json",((e,r)=>{if(!r.isFile())return!1;const i=nova.fs.open(e,"r");try{const e=JSON.parse(i.read());if(e.dependencies&&e.dependencies[t]||e.devDependencies&&e.devDependencies[t])return!0}catch{}}));if(!r)return null;const i=o(r.directory,nova.path.join("node_modules",t),((e,t)=>t.isDirectory()||t.isSymbolicLink()));return i?i.path:null}(nova.workspace.path,"prettier");if(e)return s.info(`Loading project prettier (fs) at ${e}`),e}catch(e){s.warn("Error trying to find workspace Prettier using file system",e,e.stack)}try{const e=await a(nova.workspace.path,"prettier");if(e)return s.info(`Loading project prettier (npm) at ${e.path}`),e.path}catch(e){if(127===e.status)throw e;s.warn("Error trying to find workspace Prettier using npm",e,e.stack)}}try{const e=nova.path.join(nova.extension.path,"node_modules","prettier"),t=await a(nova.extension.path,"prettier");return t&&t.correctVersion||(s.info(`Installing / updating bundled Prettier at ${e}`),await async function(e){let t,r;const i=new Promise(((e,i)=>{t=e,r=i})),s=new Process("/usr/bin/env",{args:["npm","install","--only-prod"],cwd:e});return n(s,r,t),s.start(),i}(nova.extension.path)),s.info(`Loading bundled prettier at ${e}`),e}catch(e){if(127===e.status)throw e;s.warn("Error trying to find or install bundled Prettier",e)}},{showError:T,getConfigWithWorkspaceOverride:M,observeConfigWithWorkspaceOverride:U,log:Q}=i,{Formatter:z}=N;class V{constructor(){this.didAddTextEditor=this.didAddTextEditor.bind(this),this.toggleFormatOnSave=this.toggleFormatOnSave.bind(this),this.modulePathDidChange=this.modulePathDidChange.bind(this),this.prettierConfigFileDidChange=this.prettierConfigFileDidChange.bind(this),this.editorWillSave=this.editorWillSave.bind(this),this.didInvokeFormatCommand=this.didInvokeFormatCommand.bind(this),this.didInvokeFormatSelectionCommand=this.didInvokeFormatSelectionCommand.bind(this),this.didInvokeSaveWithoutFormattingCommand=this.didInvokeSaveWithoutFormattingCommand.bind(this),this.saveListeners=new Map,this.ignoredEditors=new Set,this.issueCollection=new IssueCollection,this.formatter=new z}setupConfiguration(){nova.config.remove("prettier.use-compatibility-mode"),U("prettier.format-on-save",this.toggleFormatOnSave),U("prettier.module.path",this.modulePathDidChange)}start(){this.setupConfiguration(),nova.workspace.path&&(nova.fs.watch("**/.prettierrc*",this.prettierConfigFileDidChange),nova.fs.watch("**/package.json",this.prettierConfigFileDidChange)),nova.workspace.onDidAddTextEditor(this.didAddTextEditor),nova.commands.register("prettier.format",this.didInvokeFormatCommand),nova.commands.register("prettier.format-selection",this.didInvokeFormatSelectionCommand),nova.commands.register("prettier.save-without-formatting",this.didInvokeSaveWithoutFormattingCommand)}async startFormatter(){const e=M("prettier.module.path")||await q();Q.info(`Loading prettier at ${e}`),await this.formatter.start(e).catch((()=>new Promise((e=>setTimeout(e,1e3))).then((()=>this.formatter.start(e)))))}toggleFormatOnSave(){this.enabled=M("prettier.format-on-save"),this.enabled?nova.workspace.textEditors.forEach(this.didAddTextEditor):(this.saveListeners.forEach((e=>e.dispose())),this.saveListeners.clear())}async prettierConfigFileDidChange(){await this.formatter.stop(),await this.formatter.start()}async modulePathDidChange(){try{await this.formatter.stop(),await this.startFormatter()}catch(e){return 127===e.status?T("prettier-resolution-error","Can't find npm and Prettier","Prettier couldn't be found because npm isn't available. Please make sure you have Node installed. If you've only installed Node through NVM, you'll need to change your shell configuration to work with Nova. See https://library.panic.com/nova/environment-variables/"):(console.error("Unable to start prettier service",e,e.stack),T("prettier-resolution-error","Unable to start Prettier","Please check the extension console for additional logs."))}}didAddTextEditor(e){this.enabled&&(this.saveListeners.has(e)||this.saveListeners.set(e,e.onWillSave(this.editorWillSave)))}async editorWillSave(e){await this.formatEditor(e,!0,!1)}async didInvokeFormatCommand(e){await this.formatEditor(e,!1,!1)}async didInvokeFormatSelectionCommand(e){await this.formatEditor(e,!1,!0)}async didInvokeSaveWithoutFormattingCommand(e){this.ignoredEditors.add(e),e.save().finally((()=>this.ignoredEditors.delete(e)))}async formatEditor(e,t,r){if(!this.ignoredEditors.has(e))try{if(!await this.formatter.isReady)return;const i=await this.formatter.formatEditor(e,t,r);this.issueCollection.set(e.document.uri,i)}catch(t){console.error(t,t.stack),T("prettier-format-error","Error while formatting",`"${t.message}" occurred while formatting ${e.document.path}. See the extension console for more info.`)}}}var B=e.activate=async function(){try{(new V).start()}catch(e){return console.error("Unable to set up prettier service",e,e.stack),T("prettier-resolution-error","Unable to start Prettier","Please check the extension console for additional logs.")}},H=e.deactivate=function(){};exports.activate=B,exports.deactivate=H,exports.default=e;
