"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e={};class t extends Error{constructor(e,t){super(t),this.status=e}}function r(e){const t=nova.workspace.config.get(e),r=nova.config.get(e);return null===t?r:t}var i={showError:function(e,t,r){let i=new NotificationRequest(e);i.title=nova.localize(t),i.body=nova.localize(r),i.actions=[nova.localize("OK")],nova.notifications.add(i).catch((e=>console.error(e,e.stack)))},showActionableError:function(e,t,r,i,o){let n=new NotificationRequest(e);n.title=nova.localize(t),n.body=nova.localize(r),n.actions=i.map((e=>nova.localize(e))),nova.notifications.add(n).then((e=>o(e.actionIdx))).catch((e=>console.error(e,e.stack)))},log:Object.fromEntries(["log","info","warn"].map((e=>[e,(...t)=>{(nova.inDevMode()||r("prettier.debug.logging"))&&console[e](...t)}]))),getConfigWithWorkspaceOverride:r,observeConfigWithWorkspaceOverride:function(e,t){let r=!1;function i(...e){r?t.apply(this,e):r=!0}nova.workspace.config.observe(e,i),nova.config.observe(e,i)},ProcessError:t,handleProcessResult:function(e,r,i){const o=[];e.onStderr((e=>{o.push(e)})),e.onDidExit((e=>{0!==e?r(new t(e,o.join("\n"))):i&&i()}))},sanitizePrettierConfig:async function(){const e=nova.workspace.path+"/.nova/Configuration.json";console.info("Config Path:",e);let t="";try{let r=await nova.fs.open(e,"r");t=await r.read(),r.close(),console.info("Configuration file read successfully.")}catch(t){return void console.warn("Prettier configuration file not found or cannot be read:",e,t)}try{console.info("Raw configuration:",t);const r=JSON.parse(t);let i=!1;for(const e in r)if(e.startsWith("prettier.")){const t=r[e];console.info(`Processing key: ${e} with value: ${t}`),"Enable"===t||"Enabled"===t?(r[e]=!0,i=!0,console.info(`Key ${e} set to true`)):"Disable"===t||"Disabled"===t?(r[e]=!1,i=!0,console.info(`Key ${e} set to false`)):"Global Default"!==t&&"Globale Setting"!==t||(delete r[e],i=!0,console.info(`Key ${e} removed`))}if(i){const t=JSON.stringify(r,null,2);let i=await nova.fs.open(e,"w");await i.write(t),i.close(),console.info("Prettier configuration sanitized successfully.");let o=new NotificationRequest("prettier-config-updated");o.title="Project Configuration Updated",o.body="Your project's Prettier configuration has been updated to the new config format.",o.actions=["OK"],await nova.notifications.add(o),console.info("Notification sent.")}else console.info("Prettier configuration is already sanitized.")}catch(e){console.error("Error sanitizing Prettier configuration:",e)}}};const{handleProcessResult:o,log:n}=i;function s(e,t,r){for(;;){const i=nova.path.join(e,t),o=nova.fs.stat(i);if(o){if(r(i,o))return{directory:e,path:i}}if("/"===e)break;e=nova.path.dirname(e)}return null}async function a(e,t){let r,i;const s=new Promise(((e,t)=>{r=e,i=t})),a=new Process("/usr/bin/env",{args:["npm","ls",String(t),"--parseable","--long","--depth","0"],cwd:e});return a.onStdout((e=>{if(!e||!e.trim())return;const[i,o,s,a]=e.trim().split(":");return o&&o.startsWith(`${t}@`)?i===nova.workspace.path?(n.info(`You seem to be working on ${t}! The extension doesn't work without ${t} built, so using the built-in ${t} instead.`),r(null)):void r({path:i,correctVersion:"INVALID"!==s&&"MAXDEPTH"!==a}):r(null)})),o(a,i,r),a.start(),s}const{showError:c,showActionableError:p,log:l,getConfigWithWorkspaceOverride:d}=i,h=["arrowParens","bracketSameLine","bracketSpacing","embeddedLanguageFormatting","endOfLine","htmlWhitespaceSensitivity","insertPragma","jsxBracketSameLine","jsxSingleQuote","objectWrap","printWidth","proseWrap","quoteProps","requirePragma","semi","singleAttributePerLine","singleQuote","tabWidth","trailingComma","useTabs","vueIndentScriptAndStyle"],u=["phpVersion","trailingCommaPHP","braceStyle"],g=["xmlQuoteAttributes","xmlSelfClosingSpace","xmlSortAttributesByKey","xmlWhitespaceSensitivity"],f=["language","keywordCase","dataTypeCase","functionCase","identifierCase","logicalOperatorNewline","expressionWidth","linesBetweenQueries","denseOperators","newlineBeforeSemicolon","params","paramTypes"],m=["database","type"],v=["escapeNonLatin1","keySeparator"],y=["alignDirectives","alignUniversally","wrapParameters","continuationIndent"];var w={Formatter:class{constructor(){this.prettierServiceDidExit=this.prettierServiceDidExit.bind(this),this.prettierServiceStartDidFail=this.prettierServiceStartDidFail.bind(this),this.emitter=new Emitter,this.setupIsReadyPromise()}get defaultConfig(){return Object.fromEntries(h.map((e=>[e,d(`prettier.default-config.${e}`)])))}get phpConfig(){return Object.fromEntries(u.map((e=>[e,d(`prettier.plugins.prettier-plugin-php.${e}`)])))}get xmlConfig(){return Object.fromEntries(g.map((e=>[e,d(`prettier.plugins.prettier-plugin-xml.${e}`)])))}get sqlFormatterConfig(){return Object.fromEntries(f.map((e=>[e,d(`prettier.plugins.prettier-plugin-sql.sql-formatter.${e}`)])))}get propertiesConfig(){return Object.fromEntries(v.map((e=>[e,d(`prettier.plugins.prettier-plugin-properties.${e}`)])))}get nginxConfig(){return Object.fromEntries(y.map((e=>[e,d(`prettier.plugins.prettier-plugin-nginx.${e}`)])))}get nodeSqlParserConfig(){return Object.fromEntries(m.map((e=>[e,d(`prettier.plugins.prettier-plugin-sql.node-sql-parser.${e}`)])))}get isReady(){return this._isReadyPromise?this._isReadyPromise:(this.showServiceNotRunningError(),!1)}async start(e){e&&(this.modulePath=e),this._isReadyPromise||this.setupIsReadyPromise(),this._isStoppedPromise&&await _isStoppedPromise,this.prettierService||(l.info("Starting Prettier service"),this.prettierService=new Process("/usr/bin/env",{args:["node",nova.path.join(nova.extension.path,"Scripts","prettier-service","prettier-service.js"),this.modulePath],stdio:"jsonrpc",cwd:nova.workspace.path}),this.prettierService.onDidExit(this.prettierServiceDidExit),this.prettierService.onNotify("didStart",(()=>{this._resolveIsReadyPromise(!0)})),this.prettierService.onNotify("startDidFail",this.prettierServiceStartDidFail),this.prettierService.start())}stop(){if(nova.notifications.cancel("prettier-not-running"),this._isReadyPromise&&this.prettierService&&!this._isStoppedPromise)return l.info("Stopping Prettier service"),this._isStoppedPromise=new Promise((e=>{this._resolveIsStoppedPromise=e})),this._resolveIsReadyPromise&&this._resolveIsReadyPromise(!1),this._isReadyPromise=null,this.prettierService.terminate(),this.prettierService=null,this._isStoppedPromise}setupIsReadyPromise(){this._isReadyPromise=new Promise((e=>{this._resolveIsReadyPromise=e}))}prettierServiceDidExit(e){if(this._resolveIsStoppedPromise&&(this._resolveIsStoppedPromise(),this._isStoppedPromise=null),this.prettierService){if(console.error(`Prettier service exited with code ${e}`),this._resolveIsReadyPromise&&this._resolveIsReadyPromise(!1),this._isReadyPromise=null,this.prettierService=null,this.prettierServiceCrashedRecently)return this.showServiceNotRunningError();this.prettierServiceCrashedRecently=!0,setTimeout((()=>this.prettierServiceCrashedRecently=!1),5e3),this.start()}}prettierServiceStartDidFail({parameters:e}){this._resolveIsReadyPromise(!1),p("prettier-not-running","Couldn't Load Prettier","Please ensure your Node.js installation is up to date. Additionally, check if the 'Prettier module' path is correctly set in your extension or project settings. For more details, refer to the error log in the Extension Console",["Project settings","Extension settings"],(e=>{switch(e){case 0:nova.workspace.openConfig();break;case 1:nova.openConfig()}})),console.error(`${e.name}: ${e.message}\n${e.stack}`)}showServiceNotRunningError(){p("prettier-not-running","Prettier Stopped Running","If this problem persists, please report the issue through the Extension Library.",["Restart Prettier"],(e=>{if(0===e)this.start()}))}async formatEditorForced(e){return this.formatEditor(e,!1,!1,{force:!0})}async formatEditor(e,t,r,i={}){const{document:o}=e;nova.notifications.cancel("prettier-unsupported-syntax");const n=o.path||nova.workspace.path,s=await this.shouldApplyDefaultConfig(o,t,n);if(null===s&&!i.force)return[];l.info(`[Forced=${i.force}] Formatting ${o.path}`);const a=new Range(0,o.length),p=e.getTextInRange(a),h=d("prettier.plugins.prettier-plugin-php.enabled"),u=d("prettier.plugins.prettier-plugin-sql.enabled"),g=d("prettier.plugins.prettier-plugin-xml.enabled"),f=d("prettier.plugins.prettier-plugin-nginx.enabled"),m=d("prettier.plugins.prettier-plugin-java.enabled"),v=d("prettier.plugins.prettier-plugin-properties.enabled"),y=d("prettier.plugins.prettier-plugin-sql.formatter");let w=[];this.modulePath.includes(nova.extension.path)&&("php"===o.syntax&&h&&w.push(nova.path.join(nova.extension.path,"node_modules","@prettier","plugin-php","src","index.mjs")),"sql"===o.syntax&&u&&w.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-sql","lib","index.cjs")),"xml"===o.syntax&&g&&w.push(nova.path.join(nova.extension.path,"node_modules","@prettier","plugin-xml","src","plugin.js")),"nginx"===o.syntax&&f&&w.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-nginx","dist","index.js")),"java"===o.syntax&&m&&w.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-java","dist","index.js")),"java-properties"===o.syntax&&v&&w.push(nova.path.join(nova.extension.path,"node_modules","prettier-plugin-properties","index.js")));const S={parser:this.getParserForSyntax(o.syntax),...w.length>0?{plugins:w}:{},...o.path?{filepath:o.path}:{},...s?this.defaultConfig:{},...r?{rangeStart:e.selectedRange.start,rangeEnd:e.selectedRange.end}:{}};"php"===o.syntax&&Object.assign(S,this.phpConfig),"xml"===o.syntax&&Object.assign(S,this.xmlConfig),"sql"===o.syntax&&("sql-formatter"===y?Object.assign(S,this.sqlFormatterConfig):"node-sql-parser"===y&&Object.assign(S,this.nodeSqlParserConfig)),"java-properties"===o.syntax&&Object.assign(S,this.propertiesConfig),"nginx"===o.syntax&&Object.assign(S,this.nginxConfig),l.info("Prettier options:",JSON.stringify(S,null,2));const x=await this.prettierService.request("format",{original:p,pathForConfig:n,ignorePath:i.force?null:this.getIgnorePath(n),options:{...S,cursorOffset:e.selectedRange.start},withCursor:!0}),{formatted:b,error:P,ignored:C,missingParser:k,cursorOffset:j}=x;return this._cursorOffset=j,P?this.issuesFromPrettierError(P):C?(l.info(`Prettier is configured to ignore ${o.path}`),[]):k?(t||c("prettier-unsupported-syntax","Syntax Not Supported","Prettier doesn't include a parser for this file, and no installed plugin provides one."),l.info(`No parser for ${o.path}`),[]):b===p?(l.info(`No changes for ${o.path}`),[]):void await this.applyResult(e,p,b)}async shouldApplyDefaultConfig(e,t,r){if(t&&!0===d(`prettier.format-on-save.ignored-syntaxes.${e.syntax}`))return l.info(`Not formatting (${e.syntax} syntax ignored) ${e.path}`),null;let i=!1;if(e.isRemote){if(t&&d("prettier.format-on-save.ignore-remote"))return null}else if(i=await this.prettierService.request("hasConfig",{pathForConfig:r}),!i&&t&&d("prettier.format-on-save.ignore-without-config"))return null;return!i}getIgnorePath(e){const t=nova.workspace.path||nova.path.dirname(e);return nova.path.join(t,".prettierignore")}getParserForSyntax(e){switch(e){case"javascript":case"jsx":return"babel";case"tsx":return"typescript";case"flow":return"babel-flow";case"html+erb":return"erb";case"java-properties":return"dot-properties";default:return e}}async applyResult(e,t,r){l.info(`Applying formatted changes to ${e.document.path}`);const i=new Range(0,e.document.length);await e.edit((e=>{e.replace(i,r)}));const o=null!=this._cursorOffset?this._cursorOffset:e.selectedRange.end;e.selectedRanges=[new Range(o,o)],e.scrollToPosition(o)}async replace(e,t){const{document:r}=e,i=e.selectedRange.end,o=new Range(0,r.length);await e.edit((e=>{e.replace(o,t)})),e.selectedRanges=[new Range(i,i)]}issuesFromPrettierError(e){if("string"!=typeof e.message)return[];if("UndefinedParserError"===e.name)throw e;let t=e.message.match(/\((\d+):(\d+)\)\n/m);if(!t&&(t=e.message.match(/^>\s*?(\d+)\s\|\s/m),t)){const r=e.message.match(/^\s+\|(\s+)\^+($|\n)/im);t[2]=r?r[1].length+1:0}if(!t)throw e;const r=new Issue;return r.message=e.stack?e.message:e.message.split(/\n\s*?at\s+/i)[0],r.severity=IssueSeverity.Error,r.line=t[1],r.column=t[2],[r]}}};const S=async function(){if(nova.workspace.path){try{const e=function(e,t){const r=s(e,"package.json",((e,r)=>{if(!r.isFile())return!1;const i=nova.fs.open(e,"r");try{const e=JSON.parse(i.read());if(e.dependencies&&e.dependencies[t]||e.devDependencies&&e.devDependencies[t])return!0}catch{}}));if(!r)return null;const i=s(r.directory,nova.path.join("node_modules",t),((e,t)=>t.isDirectory()||t.isSymbolicLink()));return i?i.path:null}(nova.workspace.path,"prettier");if(e)return n.info(`Loading project prettier (fs) at ${e}`),e}catch(e){n.warn("Error trying to find workspace Prettier using file system",e,e.stack)}try{const e=await a(nova.workspace.path,"prettier");if(e)return n.info(`Loading project prettier (npm) at ${e.path}`),e.path}catch(e){if(127===e.status)throw e;n.warn("Error trying to find workspace Prettier using npm",e,e.stack)}}try{const e=nova.path.join(nova.extension.path,"node_modules","prettier"),t=!!nova.fs.stat(nova.path.join(nova.extension.path,"node_modules")),r=!!nova.fs.stat(nova.path.join(nova.extension.path,"package-lock.json"));let i=null;t&&r||(i="missing dependencies");let s={};try{const e=nova.path.join(nova.extension.path,"package.json");try{const t=nova.fs.open(e,"r").read(),r=JSON.parse(t);s={...r.dependencies||{},...r.optionalDependencies||{}}}catch(e){n.warn("Could not read or parse package.json",e)}}catch(e){n.warn("Could not read or parse package.json",e)}const c=[];for(const e of Object.keys(s))try{const t=await a(nova.extension.path,e);t&&t.correctVersion||c.push(e)}catch(t){n.warn(`Failed to verify package "${e}":`,t),c.push(e)}return c.length>0&&(i=`invalid or outdated packages: ${c.join(", ")}`),i&&(n.info(`Running npm install due to: ${i}`),await async function(e){let t,r;const i=new Promise(((e,i)=>{t=e,r=i})),n=new Process("/usr/bin/env",{args:["npm","install","--only-prod"],cwd:e});return o(n,r,t),n.start(),i}(nova.extension.path)),n.info(`Loading bundled prettier from ${e}`),e}catch(e){if(127===e.status)throw e;n.warn("Error trying to find or install bundled Prettier",e)}},{showError:x,getConfigWithWorkspaceOverride:b,observeConfigWithWorkspaceOverride:P,log:C,sanitizePrettierConfig:k}=i,{Formatter:j}=w;class E{constructor(){this.didAddTextEditor=this.didAddTextEditor.bind(this),this.toggleFormatOnSave=this.toggleFormatOnSave.bind(this),this.modulePathDidChange=this.modulePathDidChange.bind(this),this.prettierConfigFileDidChange=this.prettierConfigFileDidChange.bind(this),this.editorWillSave=this.editorWillSave.bind(this),this.didInvokeFormatCommand=this.didInvokeFormatCommand.bind(this),this.didInvokeFormatSelectionCommand=this.didInvokeFormatSelectionCommand.bind(this),this.didInvokeSaveWithoutFormattingCommand=this.didInvokeSaveWithoutFormattingCommand.bind(this),this.saveListeners=new Map,this.ignoredEditors=new Set,this.issueCollection=new IssueCollection,this.formatter=new j}setupConfiguration(){nova.config.remove("prettier.use-compatibility-mode"),nova.config.remove("prettier.plugins.prettier-plugin-php.singleQuote"),k(),P("prettier.format-on-save",this.toggleFormatOnSave),P("prettier.module.path",this.modulePathDidChange)}syncSelectionUnsupportedContext(){const e=!0===nova.config.get("prettier.selection-unsupported.dismissed");nova.workspace.context.set("prettier_selectionUnsupportedDismissed",e)}start(){if(this.setupConfiguration(),this.syncSelectionUnsupportedContext(),nova.workspace.path){const e=["**/.prettierrc","**/.prettierrc.json","**/.prettierrc.json5","**/.prettierrc.yaml","**/.prettierrc.yml","**/.prettierrc.toml","**/.prettierrc.js","**/.prettierrc.cjs","**/.prettierrc.mjs","**/.prettierrc.ts","**/.prettierrc.cts","**/.prettierrc.mts","**/prettier.config.js","**/prettier.config.cjs","**/prettier.config.mjs","**/prettier.config.ts","**/prettier.config.cts","**/prettier.config.mts","**/package.json","**/package.yaml","**/.prettierignore"];for(const t of e)nova.fs.watch(t,this.prettierConfigFileDidChange)}nova.workspace.onDidAddTextEditor(this.didAddTextEditor),nova.commands.register("prettier.format",this.didInvokeFormatCommand),nova.commands.register("prettier.format-selection",this.didInvokeFormatSelectionCommand),nova.commands.register("prettier.format-forced",this.didInvokeFormatForcedCommand.bind(this)),nova.commands.register("prettier.save-without-formatting",this.didInvokeSaveWithoutFormattingCommand),nova.commands.register("prettier.reset-suppressed-message",(()=>{nova.config.remove("prettier.selection-unsupported.dismissed"),nova.workspace.context.set("prettier_selectionUnsupportedDismissed",!1),nova.workspace.showInformativeMessage(nova.localize("Prettier+ notification restored. “Format Selection” will now reappear in the menu for unsupported syntaxes, showing a warning when used."))}))}async startFormatter(){const e=b("prettier.module.path")||await S();C.info(`Loading prettier at ${e}`),await this.formatter.start(e).catch((()=>new Promise((e=>setTimeout(e,1e3))).then((()=>this.formatter.start(e)))))}toggleFormatOnSave(){this.enabled=b("prettier.format-on-save"),this.enabled?nova.workspace.textEditors.forEach(this.didAddTextEditor):(this.saveListeners.forEach((e=>e.dispose())),this.saveListeners.clear())}async prettierConfigFileDidChange(){await this.formatter.stop(),await this.formatter.start()}async modulePathDidChange(){try{await this.formatter.stop(),await this.startFormatter()}catch(e){return 127===e.status?x("prettier-resolution-error","Can't find npm and Prettier","Prettier couldn't be found because npm isn't available. Please make sure you have Node installed. If you've only installed Node through NVM, you'll need to change your shell configuration to work with Nova. See https://library.panic.com/nova/environment-variables/"):(console.error("Unable to start prettier service",e,e.stack),x("prettier-resolution-error","Unable to start Prettier","Please check the extension console for additional logs."))}}didAddTextEditor(e){this.enabled&&(this.saveListeners.has(e)||this.saveListeners.set(e,e.onWillSave(this.editorWillSave)))}async editorWillSave(e){await this.formatEditor(e,!0,!1)}async didInvokeFormatCommand(e){await this.formatEditor(e,!1,!1)}async didInvokeFormatForcedCommand(e){try{if(!await this.formatter.isReady)return;const t=await this.formatter.formatEditorForced(e);this.issueCollection.set(e.document.uri,t)}catch(t){console.error(t,t.stack),x("prettier-format-error","Error while forcibly formatting",`"${t.message}" occurred while forcibly formatting ${e.document.path}. See the extension console for more info.`)}}async didInvokeFormatSelectionCommand(e){const t=new Set(["javascript","javascriptreact","typescript","typescriptreact","graphql","handlebars"]),r=e.document.syntax;if(!t.has(r)){const e="prettier.selection-unsupported.dismissed";if(!0===nova.config.get(e))return;let t=new NotificationRequest("prettier-selection-unsupported");return t.title=nova.localize("Unsupported Syntax"),t.body=nova.localize("“Format Selection” isn’t available for this file type. Supported syntaxes: JavaScript, TypeScript, GraphQL, and Handlebars.\n\nClicking “Dismiss” will disable the command for unsupported syntaxes."),t.actions=[nova.localize("OK"),nova.localize("Dismiss")],void nova.notifications.add(t).then((t=>{1===t.actionIdx&&(nova.config.set(e,!0),nova.workspace.context.set("prettier_selectionUnsupportedDismissed",!0))})).catch((e=>{C.error("Notification error:",e)}))}await this.formatEditor(e,!1,!0)}async didInvokeSaveWithoutFormattingCommand(e){this.ignoredEditors.add(e),e.save().finally((()=>this.ignoredEditors.delete(e)))}async formatEditor(e,t,r){if(!this.ignoredEditors.has(e))try{if(!await this.formatter.isReady)return;const i=await this.formatter.formatEditor(e,t,r);this.issueCollection.set(e.document.uri,i)}catch(t){console.error(t,t.stack),x("prettier-format-error","Error while formatting",`"${t.message}" occurred while formatting ${e.document.path}. See the extension console for more info.`)}}}var R=e.activate=async function(){try{(new E).start()}catch(e){return console.error("Unable to set up prettier service",e,e.stack),x("prettier-resolution-error","Unable to start Prettier","Please check the extension console for additional logs.")}},F=e.deactivate=function(){};exports.activate=R,exports.deactivate=F,exports.default=e;
